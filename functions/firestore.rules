rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // ============================================
    // HELPER FUNCTIONS
    // ============================================
    
    // Check if request is from authenticated client
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Check if request is from server (Cloud Function with admin token)
    function isServer() {
      return request.auth != null && request.auth.token.admin == true;
    }
    
    // Check if user owns this resource
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    // Validate timestamp is reasonable (within 24 hours of server time)
    function isValidTimestamp(timestampValue) {
      return timestampValue is number 
        && timestampValue > 0 
        && timestampValue < (request.time.toMillis() + 86400000); // +24h tolerance
    }
    
    // ============================================
    // COLLECTION 1: /alerts/{alertId}
    // CLIENT WRITES (APPEND-ONLY), SERVER ENRICHES
    // ============================================
    
    match /alerts/{alertId} {
      
      // CLIENT: Can CREATE alerts (append-only, never update/delete)
      allow create: if isAuthenticated()
                    && request.resource.data.alertId == alertId
                    && request.resource.data.sourceId is string
                    && request.resource.data.sourceId.size() > 0
                    && request.resource.data.rawAddress is string
                    && request.resource.data.rawPayload is map
                    && request.resource.data.eventTimestamp is number
                    && isValidTimestamp(request.resource.data.eventTimestamp)
                    && request.resource.data.ingestedAt == request.time.toMillis()
                    && (!('propertyId' in request.resource.data) || request.resource.data.propertyId == null)
                    && (!('normalizedAddress' in request.resource.data) || request.resource.data.normalizedAddress == null);
      
      // CLIENT: Can READ own alerts
      allow read: if isAuthenticated() 
                  && (resource.data.clientUserId == request.auth.uid || isServer());
      
      // SERVER: Can UPDATE to enrich with propertyId, normalizedAddress, geocode
      allow update: if isServer()
                    && request.resource.data.alertId == resource.data.alertId
                    && request.resource.data.sourceId == resource.data.sourceId
                    && request.resource.data.rawAddress == resource.data.rawAddress
                    && request.resource.data.rawPayload == resource.data.rawPayload
                    && request.resource.data.eventTimestamp == resource.data.eventTimestamp
                    && request.resource.data.ingestedAt == resource.data.ingestedAt;
      
      // DELETE: Never allowed (audit trail)
      allow delete: if false;
    }
    
    // ============================================
    // COLLECTION 2: /properties/{propertyId}
    // SERVER-ONLY (CRM CANONICAL DATA)
    // ============================================
    
    match /properties/{propertyId} {
      
      // READ: Authenticated users can read properties
      allow read: if isAuthenticated();
      
      // WRITE: Server-only
      allow create: if isServer()
                    && request.resource.data.propertyId == propertyId
                    && request.resource.data.normalizedAddress is string
                    && request.resource.data.lat is number
                    && request.resource.data.lng is number
                    && request.resource.data.firstAlertAt is number
                    && request.resource.data.lastAlertAt is number
                    && request.resource.data.totalAlerts is number
                    && request.resource.data.enrichmentStatus in ['pending', 'partial', 'complete', 'failed']
                    && request.resource.data.createdAt == request.time.toMillis()
                    && request.resource.data.updatedAt == request.time.toMillis();
      
      allow update: if isServer()
                    && request.resource.data.propertyId == resource.data.propertyId
                    && request.resource.data.normalizedAddress == resource.data.normalizedAddress
                    && request.resource.data.updatedAt == request.time.toMillis();
      
      // DELETE: Never allowed (canonical data)
      allow delete: if false;
      
      // Enrichments subcollection
      match /enrichments/{runId} {
        allow read: if isAuthenticated();
        allow create: if isServer()
                      && request.resource.data.runId == runId
                      && request.resource.data.propertyId == propertyId
                      && request.resource.data.provider is string
                      && request.resource.data.requestedAt is number
                      && request.resource.data.status in ['success', 'partial', 'failed'];
        allow update: if isServer();
        allow delete: if false;
      }
    }
    
    // ============================================
    // COLLECTION 3: /people/{personId}
    // SERVER-ONLY (ENRICHMENT DATA)
    // ============================================
    
    match /people/{personId} {
      allow read: if isAuthenticated();
      allow create: if isServer()
                    && request.resource.data.personId == personId
                    && request.resource.data.firstName is string
                    && request.resource.data.lastName is string
                    && request.resource.data.createdAt == request.time.toMillis()
                    && request.resource.data.updatedAt == request.time.toMillis();
      allow update: if isServer()
                    && request.resource.data.personId == resource.data.personId
                    && request.resource.data.updatedAt == request.time.toMillis();
      allow delete: if false;
    }
    
    // ============================================
    // COLLECTION 4: /contacts/{contactId}
    // SERVER-ONLY (PHONE/EMAIL DATA)
    // ============================================
    
    match /contacts/{contactId} {
      allow read: if isAuthenticated();
      allow create: if isServer()
                    && request.resource.data.contactId == contactId
                    && request.resource.data.type in ['phone', 'email']
                    && request.resource.data.value is string
                    && request.resource.data.personId is string
                    && request.resource.data.optInStatus in ['opted-in', 'opted-out', 'unknown']
                    && request.resource.data.doNotContact is bool
                    && request.resource.data.verified is bool
                    && request.resource.data.source is string
                    && request.resource.data.createdAt == request.time.toMillis()
                    && request.resource.data.updatedAt == request.time.toMillis();
      allow update: if isServer()
                    && request.resource.data.contactId == resource.data.contactId
                    && request.resource.data.updatedAt == request.time.toMillis();
      allow delete: if false;
    }
    
    // ============================================
    // COLLECTION 5: /households/{householdId}
    // SERVER-ONLY (PROPERTY-PEOPLE LINKAGE)
    // ============================================
    
    match /households/{householdId} {
      allow read: if isAuthenticated();
      allow create: if isServer()
                    && request.resource.data.householdId == householdId
                    && request.resource.data.propertyId is string
                    && request.resource.data.memberIds is list
                    && request.resource.data.createdAt == request.time.toMillis()
                    && request.resource.data.updatedAt == request.time.toMillis();
      allow update: if isServer()
                    && request.resource.data.householdId == resource.data.householdId
                    && request.resource.data.updatedAt == request.time.toMillis();
      allow delete: if false;
    }
    
    // ============================================
    // COLLECTION 6: /outreaches/{outreachId}
    // SERVER-ONLY (CAMPAIGN INSTANCES)
    // ============================================
    
    match /outreaches/{outreachId} {
      allow read: if isAuthenticated();
      allow create: if isServer()
                    && request.resource.data.outreachId == outreachId
                    && request.resource.data.propertyId is string
                    && request.resource.data.personId is string
                    && request.resource.data.contactId is string
                    && request.resource.data.messageType in ['sms', 'email']
                    && request.resource.data.status in ['queued', 'sent', 'delivered', 'failed', 'bounced']
                    && request.resource.data.queuedAt is number
                    && request.resource.data.createdAt == request.time.toMillis()
                    && request.resource.data.updatedAt == request.time.toMillis();
      allow update: if isServer()
                    && request.resource.data.outreachId == resource.data.outreachId
                    && request.resource.data.updatedAt == request.time.toMillis();
      allow delete: if false;
    }
    
    // ============================================
    // COLLECTION 7: /messages/{messageId}
    // SERVER-ONLY (COMMUNICATION LOGS)
    // ============================================
    
    match /messages/{messageId} {
      allow read: if isAuthenticated();
      allow create: if isServer()
                    && request.resource.data.messageId == messageId
                    && request.resource.data.outreachId is string
                    && request.resource.data.direction in ['outbound', 'inbound']
                    && request.resource.data.messageType in ['sms', 'email']
                    && request.resource.data.from is string
                    && request.resource.data.to is string
                    && request.resource.data.body is string
                    && request.resource.data.provider is string
                    && request.resource.data.providerMessageId is string
                    && request.resource.data.createdAt == request.time.toMillis()
                    && request.resource.data.updatedAt == request.time.toMillis();
      allow update: if isServer()
                    && request.resource.data.messageId == resource.data.messageId
                    && request.resource.data.updatedAt == request.time.toMillis();
      allow delete: if false;
    }
    
    // ============================================
    // COLLECTION 8: /config (OPTIONAL)
    // FEATURE FLAGS & SYSTEM CONFIG
    // ============================================
    
    match /config/{configKey} {
      allow read: if isAuthenticated();
      allow write: if isServer();
    }
    
    // ============================================
    // DEFAULT: DENY ALL
    // ============================================
    
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
